**APPENDIX A**

**Hardware and Software for**

**Beginning Programmers**

Some things make intuitive sense. Some we see in nature, and others are human

inventions such as the wheel or pizza.

Others require more of a leap of faith. How does a television convert some invisible

wiggles in the air into sounds and moving images?

A computer is one of these hard-to-accept ideas. How can you type something and

get a machine to do what you want?

When I was learning to program, it was hard to find answers to some basic questions.

For example: some books explain computer memory with the analogy of books on a

library shelf. I wondered, if you read from memory, the analogy implies you’re taking

a book from the shelf. So, does that erase it from memory? Actually, no. It’s more like

getting a copy of the book from the shelf.

This appendix is a short review of computer hardware and software, if you’re rela‐

tively new to programming. I try to explain the things that become “obvious” eventu‐

ally but may be sticking points at the start.

### Hardware

#### Caveman Computers

When the cavemen Og and Thog returned from hunting, they would each add a rock

to their own pile for each mammoth they slew. But they couldn’t do much with the

piles, other than gain bragging rights if one was noticeably larger than the other.

##### 501


Distant descendents of Og (Thog got stomped by a mammoth one day, trying to add

to his pile) would learn to count, and write, and use an abacus. But some leaps of

imagination and technology were needed to get beyond these tools to the concept of a

computer. The first necessary technology was electricity.

#### Electricity

Ben Franklin thought that electricity was a flow of some invisible fluid from a place

with more fluid (positive) to a place with less (negative). He was right, but got the

terms backwards. Electrons flow from his “negative” to “positive,” but electrons

weren’t discovered until much later—too late to change the terminology. So, ever

since we’ve needed to remember that electrons flow one way and current is defined as

flowing the other way.

We’re all familiar with natural electrical phenomena like static electricity and light‐

ning. After people discovered how to push electrons through conducting wires to

make electrical circuits, we got one step closer to making computers.

I used to think that electric current in a wire was caused by jazzed electrons doing

laps around the track. It’s actually quite different. Electrons jump from one atom to

another. They behave a little like ball bearings in a tube (or tapioca balls in a bubble

tea straw). When you push a ball at one end, it pushes its neighbor, and so on until

the ball at the other end is pushed out. Although an average electron moves slowly

(drift speed in a wire is only about three inches/hour), this almost-simultaneous

bumping causes the generated electromagetic wave to propagate very quickly: 50 to

99% the speed of light, depending on the conductor.

#### Inventions

We still needed:

- A way to remember things
- A way to do stuff with the things that we remembered

One memory concept was a switch: something that’s either on or off, and stays as it is

until something flips it to the other state. An electrical switch works by opening or

closing a circuit, allowing electrons to flow or blocking them. We use switches all the

time to control lights and other electrical devices. What was needed was a way to con‐

trol the switch itself by electricity.

The earliest computers (and televisions) used vacuum tubes for this purpose, but

these were big and often burned out. The single key invention that led to modern

computers was the transistor: smaller, more efficient, and more reliable. The final key

step was to make transistors much smaller and connect them in integrated circuits.

**502 | Appendix A: Hardware and Software for Beginning Programmers**


For many years, computers got faster and ridiculously cheaper as they became smaller

and smaller. Signals move faster when the components are closer together.

But there’s a limit to how small we can stuff things together. This electron friskiness

encounters resistance, which generates heat. We reached that lower limit more than

10 years ago, and manufacturers have compensated by putting multiple “chips” on the

same board. This has increased the demand for distributed computing, which I discuss

in a bit.

Regardless of these details, with these inventions we have been able to construct com‐

puters: machines that can remember things and so something with them.

#### An Idealized Computer

Real computers have lots of complex features. Let’s focus on the essential parts.

A circuit “board” contains the CPU, memory, and wires connecting them to each

other and to plugs for external devices.

#### The CPU

The CPU (Central Processing Unit), or “chip,” does the actual “computing”:

- Mathematical tasks like addition
- Comparing values

#### Memory and Caches

RAM (Random Access Memory) does the “remembering.” It’s fast, but volatile (loses

its data if power is lost).

CPUs have been getting ever faster than memory, so computer designers have been

adding caches: smaller, faster memory between the CPU and main memory. When

your CPU tries to read some bytes from memory, it first tries the closest cache (called

an L1 cache), then the next (L2), and eventually to main RAM.

#### Storage

Because main memory loses its data, we also need nonvolatile storage. Such devices

are cheaper than memory and hold much more data, but are also much slower.

The traditional storage method has been “spinning rust”: magnetic disks (or hard

drives or HDD) with movable read-write heads, a little like vinyl records and a stylus.

A hybrid technology called SSD (Solid State Drive) is made of semiconductors like

RAM, but is nonvolatile like magnetic disks. Price and speed falls between the two.

```
Hardware and Software for Beginning Programmers | 503
```

#### Inputs

How do you get data into the computer? For people, the main choices are keyboards,

mice, and touchscreens.

#### Outputs

People generally see computer output with displays and printers.

#### Relative Access Times

The amount of time it takes to get data to and from any of these components varies

tremendously. This has big practical implications, For example, software needs to run

in memory and access data there, but it also needs to store data safely on nonvolatile

devices like disks. The problem is that disks are thousands of times slower, and net‐

works are even slower. This means that programmers spend a lot of time trying to

make the best trade-offs between speed and cost.

In Computer Latency at a Human Scale, David Jeppesen compares them. I’ve derived

Table A-1 from his numbers and others. The last columns—Ratio, Relative Time

(CPU = one second) and Relative Distance (CPU = one inch)—are easier for us to

relate to than the specific timings.

Table A-1. Relative access times

```
Location Time Ratio Relative Time Relative Distance
CPU 0.4 ns 1 1 sec 1 in
L1 cache 0.9 ns 2 2 sec 2 in
L2 cache 2.8 ns 7 7 sec 7 in
L3 cache 28 ns 70 1 min 6 ft
RAM 100 ns 250 4 min 20 ft
SSD 100 μs 250,000 3 days 4 miles
Mag disk 10 ms 25,000,000 9 months 400 miles
Internet: SF→NY 65 ms 162,500,000 5 years 2,500 miles
```
It’s a good thing that a CPU instruction actually takes less than a nanosecond instead

of a whole second, or else you could have a baby in the time it takes to access a mag‐

netic disk. Because disk and network times are so much slower than CPU and RAM,

it helps to do as much work in memory as you can. And since the CPU itself is so

much faster than RAM, it makes sense to keep data contiguous, so the bytes can be

served by the faster (but smaller) caches closer to the CPU.

**504 | Appendix A: Hardware and Software for Beginning Programmers**


### Software

Given all this computer hardware, how would we control it? First, we have both

instructions (stuff that tells the CPU what to do) and data (inputs and outputs for the

instructions). In the stored-program computer, everything could be treated as data,

which simplified the design. But how do you represent instructions and data? What is

it that you save in one place and process in another? The far-flung descendants of

caveman Og wanted to know.

#### In the Beginning Was the Bit

Let’s go back to the idea of a switch: something that maintains one of two values.

These could be on or off, high or low voltage, positive or negative—just something

that can be set, won’t forget, and can later provide its value to anyone who asks. Inte‐

grated circuits gave us a way to integrate and connect billions of little switches into

small chips.

If a switch can have just two values, it can be used to represent a bit, or binary digit.

This could be treated as the tiny integers 0 and 1 , yes and no, true and false, or any‐

thing we want.

However, bits are too small for anything beyond 0 and 1. How can we convince bits to

represent bigger things?

For an answer, look at your fingers. We use only 10 digits (0 through 9) in our daily

lives, but we make numbers much bigger than 9 by positional notation. If I add 1 to

the number 38 , the 8 becomes a 9 and the whole value is now 39. If I add another 1 ,

the 9 turns into a 0 and I carry the one to the left, incrementing the 3 to a 4 and get‐

ting the final number 40. The far-right number is in the “one’s column,” the one to its

left is the “ten’s column,” and so on to the left, multiplying by 10 each time. With three

decimal digits, you can represent a thousand (10 * 10 * 10) numbers, from 000 to 999.

We can use positional notation with bits to make larger collections of them. A byte

has eight bits, with 2^8 (256) possible bit combinations. You can use a byte to store, for

example, small integers 0 to 255 (you need to save room for a zero in positional

notation).

A byte looks like eight bits in a row, each bit with a value of either 0 (or off, or false)

or 1 (or on, or true). The bit on the far right is the least significant, and the leftmost

one is the most significant.

#### Machine Language

Each computer CPU is designed with an instruction set of bit patterns (also called

opcodes) that it understands. Each opcode performs a certain function, with input

```
Hardware and Software for Beginning Programmers | 505
```

values from one place and output values to another place. CPUs have special internal

places called registers to store these opcodes and values.

Let’s use an simplified computer that works only with bytes, and has four byte-sized

registers called A, B, C, and D. Assume that:

- The command opcode goes into register A
- The command gets its byte inputs from registers B and C
- The command stores its byte result in register D

(Adding two bytes could overflow a single byte result, but I’m ignoring that here to

show what happens where.)

Say that:

- Register A contains the opcode for add two integers: a decimal 1 (binary
    00000001 ).
- Register B has the decimal value 5 (binary 00000101 ).
- Register C has the decimal value 3 (binary 00000011 ).

The CPU sees that an instruction has arrived in register A. It decodes and runs that

instruction, reading values from registers B and C and passing them to internal hard‐

ware circuits that can add bytes. When it’s done, we should see the decimal value 8

(binary 00001000 ) in register D.

The CPU does addition, and other mathematical functions, using registers in this

way. It decodes the opcode and directs control to specific circuits within the CPU. It

can also compare things, such as “Is the value in B larger than the value in C?” Impor‐

tantly, it also fetches values from memory to CPU and stores values from CPU to

memory.

The computer stores programs (machine-language instructions and data) in memory

and handles feeding instructions and data to and from the CPU.

#### Assembler

It’s hard to program in machine language. You have to get specify every bit perfectly,

which is very time consuming. So, people came up with a slightly more readable level

of languages called assembly language, or just assembler. These languages are specific

to a CPU design and let you use things like variable names to define your instruction

flow and data.

**506 | Appendix A: Hardware and Software for Beginning Programmers**


#### Higher-Level Languages

Assembler is still a painstaking endeavor, so people designed higher-level languages

that were even easier for people to use. These languages would be translated into

assembler by a program called a compiler, or run directly by an interpreter. Among

the oldest of these languages are FORTRAN, LISP, and C—wildly different in design

and intended use, but similar in their place in computer architecture.

In real jobs you tend to see distinct software “stacks”:

Mainframe

IBM, COBOL, FORTRAN, and others

Microsoft

Windows, ASP, C#, SQL Server

JVM

Java, Scala, Groovy

Open source

```
Linux, languages(Python, PHP, Perl, C, C++, Go), databases (MySQL, Post‐
greSQL), web (apache, nginx)
```
Programmers tend to stay in one of these worlds, using the languages and tools

within it. Some technologies, such as TCP/IP and the web, allow intercommunication

between stacks.

#### Operating Systems

Each innovation was built on those before it, and generally we don’t know or care

how the lower levels even work. Tools build tools to build even more tools, and we

take them for granted.

Tha major operating systems are:

Windows (Microsoft)

Commercial, many versions

macOS (Apple)

Commercial

Linux

Open source

Unix

Many commercial versions, largely replaced by Linux

```
Hardware and Software for Beginning Programmers | 507
```

```
1 This refers to “Lifting yourself by your own bootstraps,” which seems just as improbable as a computer.
```
An operating system contains:

A kernel

Schedules and controls programs and I/O

Device drivers

Used by the kernel to access RAM, disk, and other devices

Libraries

Source and binary files for use by developers

Applications

Standalone programs

The same computer hardware can support more than one operating system, but only

one at a time. When an operating system starts up, it’s called booting,^1 so rebooting is

restarting it. These terms have even appeared in movie marketing, as studios “reboot”

previous unsuccessful attempts. You can dual-boot your computer by installing more

than one operating system, side by side, but only one can be fired up and run at a

time.

If you see the phrase bare metal, it means a single computer running an operating

system. In the next few sections, we step up from bare metal.

#### Virtual Machines

An operating system is sort of a big program, so eventually someone figured out how

to run foreign operating systems as virtual machines (guest programs) on host

machines. So you could have Microsoft Windows running on your PC, but fire up a

Linux virtual machine atop it at the same time, without having to buy a second com‐

puter or dual-boot it.

#### Containers

A more recent idea is the container—a way to run multiple operating systems at the

same time, as long as they share the same kernel. This idea was popularized by

Docker, which took some little-known Linux kernel features and added useful man‐

agement features. Their analogy to shipping containers (which revolutionized ship‐

ping and saved money for all of us) was clear and appealing. By releasing the code as

open-source, Docker enabled containers to be adopted very quickly throughout the

computer industry.

**508 | Appendix A: Hardware and Software for Beginning Programmers**


```
2 You can still see the copyright notices for the University of California in some Microsoft files.
```
Google and other cloud providers had been quietly adding the underlying kernel sup‐

port to Linux for years, and using containers in their data centers. Containers use

fewer resources than virtual machines, letting you pack more programs into each

physical computer box.

#### Distributed Computing and Networks

When businesses first started using personal computers, they needed ways to make

them talk to each other as well as to devices like printers. Proprietary networking

software, such as Novell’s, was originally used, but was eventually replaced by TCP/IP

as the internet emerged in the mid- to late 90s. Microsoft grabbed its TCP/IP stack

from a free Unix variant called BSD.^2

One effect of the internet boom was a demand for servers: machines and software to

run all those web, chat, and email services. The old style of sysadmin (system admin‐

istration) was to install and manage all the hardware and software manually. Before

long, it became clear to everyone that automation was needed. In 2006, Bill Baker at

Microsoft came up with the pets versus cattle analogy for server management, and it

has since become an industry meme (sometimes as pets versus livestock, to be more

generic); see Table A-2.

Table A-2. Pets versus livestock

```
Pets Livestock
Individually named Automatically numbered
Customized care Standardized
Nurse back to health Replace
```
You’ll often see, as a successor to “sysadmin,” the term DevOps: development plus

operations, a mixture of techniques to support rapid changes to services without

blowing them up. Cloud services are extremely large and complex, and even the big

companies like Amazon and Google have outages now and then.

#### The Cloud

People had been building computer clusters for a number of years, using many tech‐

nologies. One early concept was a Beowulf cluster: identical commodity computers

(Dell or something similar, instead of workstations like Sun or HP), linked by a local

network.

```
Hardware and Software for Beginning Programmers | 509
```

The term cloud computing means using the computers in data centers to perform

computing jobs and store data—but not just for the company that owned these back‐

end resources. The services are provided to anyone, with fees based on CPU time,

disk storage amounts, and so on. Amazon and its AWS (Amazon Web Services) is the

most prominent, but Azure (Microsoft) and Google Cloud are also biggies.

Behind the scenes, these clouds use bare metal, virtual machines, and containers—all

treated as livestock, not pets.

#### Kubernetes

Companies that needed to manage huge clusters of computers in many data centers—

like Google, Amazon, and Facebook—have all borrowed or built solutions to help

them scale:

Deployment

```
How do you make new computing hardware and software available? How do you
replace them when they fail?
```
Configuration

```
How should these systems run? They need things like the names and addresses of
other computers, passwords, and security settings.
```
Orchestration

```
How do you manage all these computers, virtual machines, and containers? Can
you scale up or down to adjust to load changes?
```
Service Discovery

How do you find out who does what, and where it is?

Some competing solutions were built by Docker and others. But just in the past few

years, it looks like the battle has been won by Kubernetes.

Google had developed large internal management frameworks, codenamed Borg and

Omega. When employees brought up the idea of open sourcing these “crown jewels,”

management had to think about it a bit, but they took the leap. Google released

Kubernetes version 1.0 in 2015, and its ecosystem and influence have grown ever

since.

**510 | Appendix A: Hardware and Software for Beginning Programmers**


**APPENDIX B**

**Install Python 3**

Most of the examples in this book were written and tested with Python 3.7, the most

recent stable version at the time of writing. The What’s New in Python page presents

what was added in each version. There are many sources of Python and many ways to

install a new version. In this appendix, I describe a few of these ways:

- A standard installation downloads Python from python.org, and adds the helper
    programs pip and virtualenv.
- If your work is heavily scientific, you may prefer to get Python bundled with
    many scientific packages from Anaconda and use its package installer conda
    instead of pip.

Windows doesn’t have Python at all, and macOS, Linux, and Unix tend to have old

versions. Until they catch up, you may need to install Python 3 yourself.

### Check Your Python Version

In a terminal or terminal window, type python -V:

```
$ python -V
Python 3.7.2
```
Depending on your operating system, if you don’t have Python or the operating sys‐

tem can’t find it, you’ll get some error message like command not found.

If you do have Python and it’s version 2, you may want to install Python 3—either

system wide, or just for yourself in a virtualenv (see “Use virtualenv” on page 412 , or

“Install virtualenv” on page 517 ). In this appendix, I show how to install Python 3

system wide.

##### 511


### Install Standard Python

Go to the official Python download page with your web browser. It tries to guess your

operating system and present the appropriate choices, but if it guesses wrong, you can

use these:

- Python Releases for Windows
- Python Releases for macOS
- Python Source Releases (Linux and Unix)

You’ll see a page similar to that shown in Figure B-1.

Figure B-1. Sample download page

If you click the yellow Download Python 3.7.3 button, it will download that version

for your operating system. If you’d like to learn a little about it first, click the blue link

**512 | Appendix B: Install Python 3**


text Python 3.7.3 in the first column of the table at the bottom, under Release version.

This takes you to an information page like the one shown in Figure B-2.

Figure B-2. Detail page for download

```
Install Python 3 | 513
```

You need to scroll down the page to see the actual download links (Figure B-3).

Figure B-3. Bottom of page offering downloads

**514 | Appendix B: Install Python 3**


#### macOS

Click the macOS 64-bit/32-bit installer link to download a Mac .pkg file. Double-click

it to see an introductory dialog box (Figure B-4).

Figure B-4. Mac install dialog 1

Click Continue. You’ll go through a succession of other dialog boxes.

```
Install Python 3 | 515
```

When it’s all done, you should see the dialog shown in Figure B-5.

Figure B-5. Mac install dialog 9

Python 3 will be installed as /usr/local/bin/python3, leaving any existing Python 2 on

your computer unchanged.

#### Windows

Windows has never included Python, but recently made it easier to install. The May

2019 update for Windows 10 includes python.exe and python3.exe files. These aren’t

the Python interpreter, but links to a new Python 3.7 page at the Microsoft Store. You

can use this link to download and install Python in the same way you get other Win‐

dows software.

Or you can download and install Python from the official Python site:

- Windows x86 MSI installer (32-bit)
- Windows x86-64 MSI installer (64-bit)

**516 | Appendix B: Install Python 3**


To determine whether you have a 32-bit or 64-bit version of Windows:

- Click the Start button.
- Right-click Computer.
- Click Properties and find the bit value.

Click the appropriate installer (.msi file). After it’s downloaded, double-click it and

follow the installer directions.

#### Linux or Unix

Linux and Unix users get a choice of compressed source formats:

- XZ compressed source tarball
- Gzipped source tarball

Download either one. Decompress it by using tar xJ (.xz file) or tar xz (.tgz file)

and then run the resulting shell script.

### Install the pip Package Manager

Beyond the standard Python installation, two tools are almost essential for Python

development: pip and virtualenv.

The pip package is the most popular way to install third-party (nonstandard) Python

packages. It has been annoying that such a useful tool isn’t part of standard Python

and that you’ve needed to download and install it yourself. As a friend of mine used

to say, it’s a cruel hazing ritual. The good news is that pip is a standard part of

Python, starting with the 3.4 release.

If you have Python 3 but only the Python 2 version of pip, here’s how to get the

Python 3 version on Linux or macOS:

```
$ curl -O http://python-distribute.org/distribute_setup.py
$ sudo python3 distribute_setup.py
$ curl -O https://raw.github.com/pypa/pip/master/contrib/get-pip.py
$ sudo python3 get-pip.py
```
This installs pip-3.3 in the bin directory of your Python 3 installation. Then, use

pip-3.3 to install third-party Python packages rather than Python 2’s pip.

### Install virtualenv

Often used with pip, the virtualenv program is a way to install Python packages in a

specified directory (folder) to avoid interactions with any preexisting system Python

```
Install Python 3 | 517
```

packages. This lets you use whatever Python goodies you want, even if you don’t have

permission to change the existing installation.

Some good guides to pip and virtualenv are:

- A Non-Magical Introduction to Pip and Virtualenv for Python Beginners
- The Hitchhiker’s Guide to Packaging: Pip

### Other Packaging Solutions

As you’ve seen, Python’s packaging techniques vary, and none work well for every

problem. The PyPA (Python Packaging Authority) is a volunteer working group (not

part of the official Python development core group) that’s trying to simplify Python

packaging. The group wrote the Python Packaging User’s Guide, which discusses

problems and solutions.

The most popular tools are pip and virtualenv, and I’ve used these throughout this

book. If they fall short for you, or if you like trying new things, here are some

alternatives:

- pipenv combines pip and virtualenv and adds more features. See also some
    criticism and threaded discussion.
- poetry is a rival that addresses some of the problems with pipenv.

But the most prominent packaging alternative, especially for scientific and data-heavy

applications, is conda. You can get it as part of the Anaconda Python distribution,

which I talk about next, or by itself (“Install Anaconda’s Package Manager conda” on

page 519).

### Install Anaconda

Anaconda is an all-in-one distribution with an emphasis on science. The latest ver‐

sion, Anaconda3, includes Python 3.7 and its standard library as well as the R lan‐

guage for data science. Other goodies include libraries that we’ve talked about in this

book: beautifulsoup4, flask, ipython, matplotlib, nose, numpy, pandas, pillow,

pip, scipy, tables, zmq, and many others. It also has a cross-platform installation

program called conda, which I get to in the next section.

To install Anaconda3, go to the download page for the Python 3 versions. Click the

appropriate link for your platform (version numbers might have changed since this

was written, but you can figure it out):

**518 | Appendix B: Install Python 3**


- The macOS installer will install everything to the anaconda directory under your
    home directory.
- For Windows, double-click the .exe file after it downloads.
- For Linux, choose the 32-bit version or the 64-bit version. After it has downloa‐
    ded, execute it (it’s a big shell script).

```
Ensure that the name of the file you download starts with Ana‐
conda3. If it starts with just Anaconda, that’s the Python 2 version.
```
Anaconda installs everything in its own directory (anaconda under your home direc‐

tory). This means that it won’t interfere with any versions of Python that might

already be on your computer. It also means that you don’t need any special permis‐

sion (account names like admin or root) to install it either.

Anaconda now includes more than 1,500 open source packages. Visit the Anaconda

docs page and click the link for your platform and Python version.

After installing Anaconda3, you can see what Santa put on your computer by typing

the command conda list.

#### Install Anaconda’s Package Manager conda

The Anaconda developers built conda to address the problems they’ve seen with pip

and other tools. pip is a Python package manager, but conda works with any software

and language. conda also avoids the need for something like virtualenv to keep

installations from stepping on one another.

If you installed the Anaconda distribution, you already have the conda program. If

not, you can get Python 3 and conda from the miniconda page. As with Anaconda,

make sure the file you download starts with Miniconda3; if it starts with Miniconda

alone, it’s the Python 2 version.

conda works with pip. Although it has its own public package repository, commands

like conda search will also search the PyPi repository. If you have problems with

pip, conda might be a good alternative.

```
Install Python 3 | 519
```


**APPENDIX C**

**Something Completely Different: Async**

Our first two appendixes were for beginning programmers, but this one is for those

who are a bit advanced.

Like most programming languages, Python has been synchronous. It runs through

code linearly, a line at a time, from top to bottom. When you call a function, Python

jumps into its code, and the caller waits until the function returns before resuming

what it was doing.

Your CPU can do only one thing at a time, so synchronous execution makes perfect

sense. But it turns out that often a program is not actually running any code, but

waiting for something, like data from a file or a network service. This is like us staring

at a browser screen while waiting for a site to load. If we could avoid this “busy wait‐

ing,” we might shorten the total time of our programs. This is also called improving

throughput.

In Chapter 15, you saw that if you want some concurrency, your choices included

threads, processes, or a third-party solution like gevent or twisted. But there are

now a growing number of asynchronous answers, both built in to Python and third-

party solutions. These coexist with the usual synchronous Python code, but, to bor‐

row a Ghostbusters warning, you can’t cross the streams. I’ll show you how to avoid

any ectoplasmic side effects.

##### 521


### Coroutines and Event Loops

In Python 3.4, Python added a standard asynchronous module called asyncio. Python

3.5 then added the keywords async and await. These implement some new concepts:

- Coroutines are functions that pause at various points
- An event loop that schedules and runs coroutines

These let us write asynchronous code that looks something like the normal synchro‐

nous code that we’re used to. Otherwise, we’d need to use one of the methods men‐

tioned in Chapter 15 and Chapter 17, and summarized later in “Async Versus...” on

page 525.

Normal multitasking is what your operating system does to your processes. It decides

what’s fair, who’s being a CPU hog, when to open the I/O spigots, and so on. The

event loop, however, provides cooperative multitasking, in which coroutines indicate

when they’re able to start and stop. They run in a single thread, so you don’t have the

potential issues that I mentioned in “Threads” on page 287.

You define a coroutine by putting async before its initial def. You call a coroutine by:

- Putting await before it, which quietly adds the coroutine to an existing event
    loop. You can do this only within another coroutine.
- Or by using asyncio.run(), which explicitly starts an event loop.
- Or by using asyncio.create_task() or asyncio.ensure_future().

This example uses the first two calling methods:

```
>>> import asyncio
>>>
>>> async def wicked():
... print ("Surrender,")
... await asyncio.sleep(2)
... print ("Dorothy!")
...
>>> asyncio.run(wicked())
Surrender,
Dorothy!
```
These was a dramatic two-second wait in there that you can’t see on a printed page.

To prove that we didn’t cheat (see Chapter 19 for timeit details):

```
>>> from timeit import timeit
>>> timeit("asyncio.run(wicked())", globals=globals(), number=1)
Surrender,
Dorothy!
2.005701574998966
```
**522 | Appendix C: Something Completely Different: Async**


That asyncio.sleep(2) call was itself a coroutine, just an example here to fake some‐

thing time consuming like an API call.

The line asyncio.run(wicked()) is a way of running a coroutine from synchronous

Python code (here, the top level of the program).

The difference from a standard synchronous counterpart (using time.sleep()) is

that the caller of wicked() is not blocked for two seconds while it runs.

The third way to run a coroutine is to create a task and await it. This example shows

the task approach along with the previous two methods:

```
>>> import asyncio
>>>
>>> async def say(phrase, seconds):
... print (phrase)
... await asyncio.sleep(seconds)
...
>>> async def wicked():
... task_1 = asyncio.create_task(say("Surrender,", 2))
... task_2 = asyncio.create_task(say("Dorothy!", 0))
... await task_1
... await task_2
...
>>> asyncio.run(wicked())
Surrender,
Dorothy!
```
If you run this, you’ll see that there was no delay between the two lines printing this

time. That’s because they were separate tasks. task_1 paused two seconds after print‐

ing Surrender, but that didn’t affect task_2.

An await is similar to a yield in a generator, but rather than returning a value, it

marks a spot where the event loop can pause it if needed.

There’s lots more where this came from in the docs. Synchronous and asynchronous

code can coexist in the same program. Just remember to put async before the def and

await before the call of your asynchronous function.

Some more information:

- A list of asyncio links.
- Code for an asyncio web crawler.

```
Something Completely Different: Async | 523
```

### Asyncio Alternatives

Although asyncio is a standard Python package, you can use async and await

without it. Coroutines and the event loop are independent. The design of asyncio is

sometimes criticized, and third-party alternatives have appeared:

- curio
- trio

Let’s show a real example using trio and asks (an async web framework, modeled on

the requests API). Example C-1 shows a concurrent web-crawling example using

trio and asks, adapted from a stackoverflow answer. To run this, first pip install

both trio and asks.

Example C-1. trio_asks_sites.py

**import time**

**import asks
import trio**

asks.init("trio")

urls = [
'https://boredomtherapy.com/bad-taxidermy/',
'http://www.badtaxidermy.com/',
'https://crappytaxidermy.com/',
'https://www.ranker.com/list/bad-taxidermy-pictures/ashley-reign',
]

async **def** get_one(url, t1):
r = await asks.get(url)
t2 = time.time()
**print** (f"{(t2-t1):.04} **\t** {len(r.content)} **\t** {url}")

async **def** get_sites(sites):
t1 = time.time()
async **with** trio.open_nursery() **as** nursery:
**for** url **in** sites:
nursery.start_soon(get_one, url, t1)

**if __name__** == "__main__":
**print** ("seconds **\t** bytes **\t** url")
trio.run(get_sites, urls)

**524 | Appendix C: Something Completely Different: Async**


Here’s what I got:

```
$ python trio_asks_sites.py
seconds bytes url
0.1287 5735 https://boredomtherapy.com/bad-taxidermy/
0.2134 146082 https://www.ranker.com/list/bad-taxidermy-pictures/ashley-reign
0.215 11029 http://www.badtaxidermy.com/
0.3813 52385 https://crappytaxidermy.com/
```
You’ll notice that trio did not use asyncio.run(), but instead its own

trio.open_nursery(). If you’re curious, you can read an essay and discussion of the

design decisions behind trio.

A new package called AnyIO provides a single interface to asyncio, curio, and trio.

In the future, you can expect more async approaches, both in standard Python and

from third-party developers.

### Async Versus...

As you’ve seen in many places in this book, there are many techniques for concur‐

rency. How does the async stuff compare with them?

Processes

```
This is a good solution if you want to use all the CPU cores on your machine, or
multiple machines. But processes are heavy, take a while to start, and require seri‐
alization for interprocess communication.
```
Threads

```
Although threads were designed as a “lightweight” alternative to processes, each
thread uses a good chunk of memory. Coroutines are much lighter than threads;
you can create hundreds of thousands of coroutines on a machine that might
only support a few thousand threads.
```
Green threads

```
Green threads like gevent work well and look like synchronous code, but they
require monkey-patching standard Python functions, such as socket libraries.
```
Callbacks

```
Libraries like twisted rely on callbacks: functions that are called when when cer‐
tain events occur. This is familiar to GUI and JavaScript programmers.
```
Queues—These tend to be a large-scale solution, when your data or processes really

need more than one machine.

```
Something Completely Different: Async | 525
```

### Async Frameworks and Servers

The async additions to Python are recent, and it’s taking time for developers to create

async versions of frameworks like Flask.

The ASGI standard is an async version of WSGI, discussed further here.

Here are some ASGI web servers:

- hypercorn
- sanic
- uvicorn

And some async web frameworks:

- aiohttp—Client and server
- api_hour
- asks—Like requests
- blacksheep
- bocadillo
- channels
- fastapi—Uses type annotations
- muffin
- quart
- responder
- sanic
- starlette
- tornado
- vibora

Finally, some async database interfaces:

- aiomysql
- aioredis
- asyncpg

**526 | Appendix C: Something Completely Different: Async**


**APPENDIX D**

**Answers to Exercises**

### 1. A Taste of Py

1.1 If you don’t already have Python 3 installed on your computer, do it now. Read

Appendix B for the details for your computer system.

1.2 Start the Python 3 interactive interpreter. Again, details are in Appendix B. It

should print a few lines about itself and then a single line starting with >>>. That’s

your prompt to type Python commands.

```
Here’s what it looks like on my Mac:
```
```
$ python
Python 3.7.3 (v3.7.3:ef4ec6ed12, Mar 25 2019, 16:39:00)
[GCC 4.2.1 (Apple Inc. build 5666) (dot 3)] on darwin
Type "help", "copyright", "credits" or "license" for more information.
>>>
```
1.3 Play with the interpreter a little. Use it like a calculator and type this: 8 * 9. Press

the Enter key to see the result. Python should print 72.

##### >>> 8 * 9

##### 72

##### 527


1.4 Type the number 47 and press the Enter key. Did it print 47 for you on the next

line?

##### >>> 47

##### 47

1.5 Now type print(47) and press Enter. Did that also print 47 for you on the next

line?

```
>>> print (47)
47
```
### 2. Data: Types, Values, Variables, and Names

2.1 Assign the integer value 99 to the variable prince, and print it.

```
>>> prince = 99
>>> print (prince)
99
>>>
```
2.2 What type is the value 5?

```
>>> type(5)
<class 'int'>
```
2.3 What type is the value 2.0?

```
>>> type(2.0)
<class 'float'>
```
**528 | Appendix D: Answers to Exercises**


2.4 What type is the expression 5 + 2.0?

```
>>> type(5 + 2.0)
<class 'float'>
```
### 3. Numbers

3.1 How many seconds are in an hour? Use the interactive interpreter as a calculator

and multiply the number of seconds in a minute ( 60 ) by the number of minutes in an

hour (also 60 ).

##### >>> 60 * 60

##### 3600

3.2 Assign the result from the previous task (seconds in an hour) to a variable called

seconds_per_hour.

```
>>> seconds_per_hour = 60 * 60
>>> seconds_per_hour
3600
```
3.3 How many seconds are in a day? Use your seconds_per_hour variable.

```
>>> seconds_per_hour * 24
86400
```
3.4 Calculate seconds per day again, but this time save the result in a variable called

seconds_per_day.

```
>>> seconds_per_day = seconds_per_hour * 24
>>> seconds_per_day
86400
```
```
Answers to Exercises | 529
```

3.5 Divide seconds_per_day by seconds_per_hour. Use floating-point (/) division.

```
>>> seconds_per_day / seconds_per_hour
24.0
```
3.6 Divide seconds_per_day by seconds_per_hour, using integer (//) division. Did

this number agree with the floating-point value from the previous question, aside

from the final .0?

```
>>> seconds_per_day // seconds_per_hour
24
```
### 4. Choose with if

4.1 Choose a number between 1 and 10 and assign it to the variable secret. Then,

select another number between 1 and 10 and assign it to the variable guess. Next,

write the conditional tests (if, else, and elif) to print the string 'too low' if guess

is less than secret, 'too high' if greater than secret, and 'just right' if equal to

secret.

```
Did you choose 7 for secret? I bet a lot of people do, because there’s something about
7.
```
```
secret = 7
guess = 5
if guess < secret:
print ('too low')
elif guess > secret:
print ('too high')
else :
print ('just right')
```
```
Run this program and you should see the following:
```
```
too low
```
**530 | Appendix D: Answers to Exercises**


4.2 Assign True or False to the variables small and green. Write some if/else state‐

ments to print which of these matches those choices: cherry, pea, watermelon,

pumpkin.

```
>>> small = False
>>> green = True
>>> if small:
... if green:
... print ("pea")
... else :
... print ("cherry")
... else :
... if green:
... print ("watermelon")
... else :
... print ("pumpkin")
...
watermelon
```
### 5. Text Strings

5.1 Capitalize the word starting with m:

```
>>> song = """When an eel grabs your arm,
... And it causes great harm,
... That's - a moray!"""
```
```
Don’t forget the space before the m:
```
```
>>> song = """When an eel grabs your arm,
... And it causes great harm,
... That's - a moray!"""
>>> song = song.replace(" m", " M")
>>> print (song)
When an eel grabs your arm,
And it causes great harm,
That's - a Moray!
```
5.2 Print each list question with its correctly matching answer, in the form:

Q: question

A: answer

```
>>> questions = [
... "We don't serve strings around here. Are you a string?",
... "What is said on Father's Day in the forest?",
```
```
Answers to Exercises | 531
```

```
... "What makes the sound 'Sis! Boom! Bah!'?"
... ]
>>> answers = [
... "An exploding sheep.",
... "No, I'm a frayed knot.",
... "'Pop!' goes the weasel."
... ]
```
```
You could print each item in questions with its mate from answers in many ways.
Let’s try a tuple sandwich (tuples in a tuple) to pair them, and tuple unpacking to
retrieve them for printing:
```
```
questions = [
"We don't serve strings around here. Are you a string?",
"What is said on Father's Day in the forest?",
"What makes the sound 'Sis! Boom! Bah!'?"
]
answers = [
"An exploding sheep.",
"No, I'm a frayed knot.",
"'Pop!' goes the weasel."
]
```
```
q_a = ( (0, 1), (1,2), (2, 0) )
for q, a in q_a:
print ("Q:", questions[q])
print ("A:", answers[a])
print ()
```
```
Output:
```
```
$ python qanda.py
Q: We don't serve strings around here. Are you a string?
A: No, I'm a frayed knot.
```
```
Q: What is said on Father's Day in the forest?
A: 'Pop!' goes the weasel.
```
```
Q: What makes the sound 'Sis! Boom! Bah!'?
A: An exploding sheep.
```
5.3 Write the following poem by using old-style formatting. Substitute the strings

'roast beef', 'ham', 'head', and 'clam' into this string:

```
My kitty cat likes %s,
My kitty cat likes %s,
My kitty cat fell on his %s
And now thinks he's a %s.
```
**532 | Appendix D: Answers to Exercises**


```
>>> poem = '''
... My kitty cat likes %s,
... My kitty cat likes %s,
... My kitty cat fell on his %s
... And now thinks he's a %s.
... '''
>>> args = ('roast beef', 'ham', 'head', 'clam')
>>> print (poem % args)
```
```
My kitty cat likes roast beef,
My kitty cat likes ham,
My kitty cat fell on his head
And now thinks he's a clam.
```
5.4 Write a form letter by using new-style formatting. Save the following string as

letter (you’ll use it in the next exercise):

```
Dear {salutation} {name},
```
```
Thank you for your letter. We are sorry that our {product}
{verbed} in your {room}. Please note that it should never
be used in a {room}, especially near any {animals}.
```
```
Send us your receipt and {amount} for shipping and handling.
We will send you another {product} that, in our tests,
is {percent}% less likely to have {verbed}.
```
```
Thank you for your support.
```
```
Sincerely,
{spokesman}
{job_title}
```
```
>>> letter = '''
... Dear {salutation} {name},
...
... Thank you for your letter. We are sorry that our {product}
... {verbed} in your {room}. Please note that it should never
... be used in a {room}, especially near any {animals}.
...
... Send us your receipt and {amount} for shipping and handling.
... We will send you another {product} that, in our tests,
... is {percent}% less likely to have {verbed}.
...
... Thank you for your support.
...
... Sincerely,
```
```
Answers to Exercises | 533
```

```
... {spokesman}
... {job_title}
... '''
```
5.5 Assign values to variable strings named 'salutation', 'name', 'product', 'ver

bed' (past tense verb), 'room', 'animals', 'percent', 'spokesman', and

'job_title'. Print letter with these values, using letter.format().

```
>>> print (
... letter.format(salutation='Ambassador',
... name='Nibbler',
... product='pudding',
... verbed='evaporated',
... room='gazebo',
... animals='octothorpes',
... amount='$1.99',
... percent=88,
... spokesman='Shirley Iugeste',
... job_title='I Hate This Job')
... )
```
```
Dear Ambassador Nibbler,
```
```
Thank you for your letter. We are sorry that our pudding
evaporated in your gazebo. Please note that it should never
be used in a gazebo, especially near any octothorpes.
```
```
Send us your receipt and $1.99 for shipping and handling.
We will send you another pudding that, in our tests,
is 88% less likely to have evaporated.
```
```
Thank you for your support.
```
```
Sincerely,
Shirley Iugeste
I Hate This Job
```
**534 | Appendix D: Answers to Exercises**


5.6 After public polls to name things, a pattern emerged: an English submarine

(Boaty McBoatface), an Australian racehorse (Horsey McHorseface), and a Swedish

train (Trainy McTrainface). Use % formatting to print the winning name at the state

fair for a prize duck, gourd, and spitz.

Example D-1. mcnames1.py

```
names = ["duck", "gourd", "spitz"]
for name in names:
cap_name = name.capitalize()
print ("%sy Mc%sface" % (cap_name, cap_name))
```
```
Output:
```
```
Ducky McDuckface
Gourdy McGourdface
Spitzy McSpitzface
```
5.7 Do the same, with format() formatting.

Example D-2. mcnames2.py

```
names = ["duck", "gourd", "spitz"]
for name in names:
cap_name = name.capitalize()
print ("{}y Mc{}face".format(cap_name, cap_name))
```
5.8 Once more, with feeling, and f strings.

Example D-3. mcnames3.py

```
names = ["duck", "gourd", "spitz"]
for name in names:
cap_name = name.capitalize()
print (f"{cap_name}y Mc{cap_name}face")
```
```
Answers to Exercises | 535
```

### 6. Loop with while and for

6.1 Use a for loop to print the values of the list [3, 2, 1, 0].

```
>>> for value in [3, 2, 1, 0]:
... print (value)
...
3
2
1
0
```
6.2 Assign the value 7 to the variable guess_me, and the value 1 to the variable num

ber. Write a while loop that compares number with guess_me. Print 'too low' if num

ber is less than guess me. If number equals guess_me, print 'found it!' and then

exit the loop. If number is greater than guess_me, print 'oops' and then exit the loop.

Increment number at the end of the loop.

```
guess_me = 7
number = 1
while True:
if number < guess_me:
print ('too low')
elif number == guess_me:
print ('found it!')
break
elif number > guess_me:
print ('oops')
break
number += 1
```
```
If you did this right, you should see this:
```
```
too low
too low
too low
too low
too low
too low
found it!
```
```
Notice that the elif start > guess_me: line could have been a simple else:,
because if start is not less than or equal to guess_me, it must be greater—at least in
this universe.
```
**536 | Appendix D: Answers to Exercises**


6.3 Assign the value 5 to the variable guess_me. Use a for loop to iterate a variable

called number over range(10). If number is less than guess_me, print 'too low'. If it

equals guess_me, print found it! and then break out of the for loop. If number is

greater than guess_me, print 'oops' and then exit the loop.

```
>>> guess_me = 5
>>> for number in range(10):
... if number < guess_me:
... print ("too low")
... elif number == guess_me:
... print ("found it!")
... break
... else :
... print ("oops")
... break
...
too low
too low
too low
too low
too low
found it!
```
### 7. Tuples and Lists

7.1 Create a list called years_list, starting with the year of your birth, and each year

thereafter until the year of your fifth birthday. For example, if you were born in 1980,

the list would be years_list = [1980, 1981, 1982, 1983, 1984, 1985].

```
If you were born in 1980, you would type:
```
```
>>> years_list = [1980, 1981, 1982, 1983, 1984, 1985]
```
7.2 In which of these years was your third birthday? Remember, you were 0 years of

age for your first year.

```
You want offset 3. Thus, if you were born in 1980:
```
```
>>> years_list[3]
1983
```
```
Answers to Exercises | 537
```

7.3 In which year in years_list were you the oldest?

```
You want the last year, so use offset -1. You could also say 5 because you know this list
has six items, but -1 gets the last item from a list of any size. For a 1980-vintage per‐
son:
```
```
>>> years_list[-1]
1985
```
7.4 Make and print a list called things with these three strings as elements:

"mozzarella", "cinderella", "salmonella".

```
>>> things = ["mozzarella", "cinderella", "salmonella"]
>>> things
['mozzarella', 'cinderella', 'salmonella']
```
7.5 Capitalize the element in things that refers to a person and then print the list. Did

it change the element in the list?

```
This capitalizes the word but doesn’t change it in the list:
```
```
>>> things[1].capitalize()
'Cinderella'
>>> things
['mozzarella', 'cinderella', 'salmonella']
```
```
If you want to change it in the list, you need to assign it back:
```
```
>>> things[1] = things[1].capitalize()
>>> things
['mozzarella', 'Cinderella', 'salmonella']
```
7.6 Make the cheesy element of things all uppercase and then print the list.

```
>>> things[0] = things[0].upper()
>>> things
['MOZZARELLA', 'Cinderella', 'salmonella']
```
**538 | Appendix D: Answers to Exercises**


7.7 Delete the disease element, collect your Nobel Prize, and then print the list.

```
This would remove it by value:
```
```
>>> things.remove("salmonella")
>>> things
['MOZZARELLA', 'Cinderella']
```
```
Because it was last in the list, the following would have worked also:
```
```
>>> del things[-1]
```
```
And you could have deleted by offset from the beginning:
```
```
>>> del things[2]
```
7.8 Create a list called surprise with the elements "Groucho", "Chico", and "Harpo".

```
>>> surprise = ['Groucho', 'Chico', 'Harpo']
>>> surprise
['Groucho', 'Chico', 'Harpo']
```
7.9 Lowercase the last element of the surprise list, reverse it, and then capitalize it.

```
>>> surprise[-1] = surprise[-1].lower()
>>> surprise[-1] = surprise[-1][::-1]
>>> surprise[-1].capitalize()
'Oprah'
```
7.10 Use a list comprehension to make a list called even of the even numbers in

range(10).

```
>>> even = [number for number in range(10) if number % 2 == 0]
>>> even
[0, 2, 4, 6, 8]
```
```
Answers to Exercises | 539
```

7.11 Let’s create a jumprope rhyme maker. You’ll print a series of two-line rhymes.

Start with this program fragment:

```
start1 = ["fee", "fie", "foe"]
rhymes = [
("flop", "get a mop"),
("fope", "turn the rope"),
("fa", "get your ma"),
("fudge", "call the judge"),
("fat", "pet the cat"),
("fog", "walk the dog"),
("fun", "say we're done"),
]
start2 = "Someone better"
```
For each string pair (first, second) in rhymes:

For the first line:

- Print each string in start1, capitalized and followed by an exclamation point and
    a space.
- Print first, also capitalized and followed by an exclamation point.

For the second line:

- Print start2 and a space.
- Print second and a period.

```
start1 = ["fee", "fie", "foe"]
rhymes = [
("flop", "get a mop"),
("fope", "turn the rope"),
("fa", "get your ma"),
("fudge", "call the judge"),
("fat", "pet the cat"),
("fog", "pet the dog"),
("fun", "say we're done"),
]
start2 = "Someone better"
start1_caps = " ".join([word.capitalize() + "!" for word in start1])
for first, second in rhymes:
print (f"{start1_caps} {first.capitalize()}!")
print (f"{start2} {second}.")
```
```
Output:
```
```
Fee! Fie! Foe! Flop!
Someone better get a mop.
```
**540 | Appendix D: Answers to Exercises**


```
Fee! Fie! Foe! Fope!
Someone better turn the rope.
Fee! Fie! Foe! Fa!
Someone better get your ma.
Fee! Fie! Foe! Fudge!
Someone better call the judge.
Fee! Fie! Foe! Fat!
Someone better pet the cat.
Fee! Fie! Foe! Fog!
Someone better walk the dog.
Fee! Fie! Foe! Fun!
Someone better say we're done.
```
### 8. Dictionaries

8.1 Make an English-to-French dictionary called e2f and print it. Here are your

starter words: dog is chien, cat is chat, and walrus is morse.

```
>>> e2f = {'dog': 'chien', 'cat': 'chat', 'walrus': 'morse'}
>>> e2f
{'cat': 'chat', 'walrus': 'morse', 'dog': 'chien'}
```
8.2 Using your three-word dictionary e2f, print the French word for walrus.

```
>>> e2f['walrus']
'morse'
```
8.3 Make a French-to-English dictionary called f2e from e2f. Use the items method.

```
>>> f2e = {}
>>> for english, french in e2f.items():
f2e[french] = english
>>> f2e
{'morse': 'walrus', 'chien': 'dog', 'chat': 'cat'}
```
8.4 Print the English equivalent of the French word chien.

```
>>> f2e['chien']
'dog'
```
```
Answers to Exercises | 541
```

8.5 Print the set of English words from e2f.

```
>>> set(e2f.keys())
{'cat', 'walrus', 'dog'}
```
8.6 Make a multilevel dictionary called life. Use these strings for the topmost keys:

'animals', 'plants', and 'other'. Make the 'animals' key refer to another dictio‐

nary with the keys 'cats', 'octopi', and 'emus'. Make the 'cats' key refer to a list

of strings with the values 'Henri', 'Grumpy', and 'Lucy'. Make all the other keys

refer to empty dictionaries.

```
This is a hard one, so don’t feel bad if you peeked here first.
```
```
>>> life = {
... 'animals': {
... 'cats': [
... 'Henri', 'Grumpy', 'Lucy'
... ],
... 'octopi': {},
... 'emus': {}
... },
... 'plants': {},
... 'other': {}
... }
>>>
```
8.7 Print the top-level keys of life.

```
>>> print (life.keys())
dict_keys(['animals', 'other', 'plants'])
```
```
Python 3 includes that dict_keys stuff. To print them as a plain list, use this:
```
```
>>> print (list(life.keys()))
['animals', 'other', 'plants']
```
```
By the way, you can use spaces to make your code easier to read:
```
```
>>> print ( list ( life.keys() ) )
['animals', 'other', 'plants']
```
**542 | Appendix D: Answers to Exercises**


8.8 Print the keys for life['animals'].

```
>>> print (life['animals'].keys())
dict_keys(['cats', 'octopi', 'emus'])
```
8.9 Print the values for life['animals']['cats'].

```
>>> print (life['animals']['cats'])
['Henri', 'Grumpy', 'Lucy']
```
8.10 Use a dictionary comprehension to create the dictionary squares. Use

range(10) to return the keys, and use the square of each key as its value.

```
>>> squares = {key: key*key for key in range(10)}
>>> squares
{0: 0, 1: 1, 2: 4, 3: 9, 4: 16, 5: 25, 6: 36, 7: 49, 8: 64, 9: 81}
```
8.11 Use a set comprehension to create the set odd from the odd numbers in

range(10).

```
>>> odd = {number for number in range(10) if number % 2 == 1}
>>> odd
{1, 3, 5, 7, 9}
```
8.12 Use a generator comprehension to return the string 'Got ' and a number for the

numbers in range(10). Iterate through this by using a for loop.

```
>>> for thing in ('Got %s' % number for number in range(10)):
... print (thing)
...
Got 0
Got 1
Got 2
Got 3
Got 4
Got 5
Got 6
Got 7
```
```
Answers to Exercises | 543
```

```
Got 8
Got 9
```
8.13 Use zip() to make a dictionary from the key tuple ('optimist', 'pessimist',

'troll') and the values tuple ('The glass is half full', 'The glass is half

empty', 'How did you get a glass?').

```
>>> keys = ('optimist', 'pessimist', 'troll')
>>> values = ('The glass is half full',
... 'The glass is half empty',
... 'How did you get a glass?')
>>> dict(zip(keys, values))
{'optimist': 'The glass is half full',
'pessimist': 'The glass is half empty',
'troll': 'How did you get a glass?'}
```
8.14 Use zip() to make a dictionary called movies that pairs these lists: titles =

['Creature of Habit', 'Crewel Fate', 'Sharks On a Plane'] and plots = ['A

nun turns into a monster', 'A haunted yarn shop', 'Check your exits']

```
>>> titles = ['Creature of Habit',
... 'Crewel Fate',
... 'Sharks On a Plane']
>>> plots = ['A nun turns into a monster',
... 'A haunted yarn shop',
... 'Check your exits']
>>> movies = dict(zip(titles, plots))
>>> movies
{'Creature of Habit': 'A nun turns into a monster',
'Crewel Fate': 'A haunted yarn shop',
'Sharks On a Plane': 'Check your exits'}
>>>
```
### 9. Functions

9.1 Define a function called good() that returns the following list: ['Harry', 'Ron',

'Hermione'].

```
>>> def good():
... return ['Harry', 'Ron', 'Hermione']
...
```
**544 | Appendix D: Answers to Exercises**


```
>>> good()
['Harry', 'Ron', 'Hermione']
```
9.2 Define a generator function called get_odds() that returns the odd numbers from

range(10). Use a for loop to find and print the third value returned.

```
>>> def get_odds():
... for number in range(1, 10, 2):
... yield number
...
>>> count = 1
>>> for number in get_odds():
... if count == 3:
... print ("The third odd number is", number)
... break
... count += 1
...
The third odd number is 5
```
9.3 Define a decorator called test that prints 'start' when a function is called, and

'end' when it finishes.

```
>>> def test(func):
... def new_func(*args, **kwargs):
... print ('start')
... result = func(*args, **kwargs)
... print ('end')
... return result
... return new_func
...
>>>
>>> @test
... def greeting():
... print ("Greetings, Earthling")
...
>>> greeting()
start
Greetings, Earthling
end
```
```
Answers to Exercises | 545
```

9.4 Define an exception called OopsException. Raise this exception to see what hap‐

pens. Then, write the code to catch this exception and print 'Caught an oops'.

```
>>> class OopsException ( Exception ):
... pass
...
>>> raise OopsException()
Traceback (most recent call last):
File "<stdin>", line 1, in <module>
__main__.OopsException
>>>
>>> try :
... raise OopsException
... except OopsException:
... print ('Caught an oops')
...
Caught an oops
```
### 10. Oh Oh: Objects and Classes

10.1 Make a class called Thing with no contents and print it. Then, create an object

called example from this class and also print it. Are the printed values the same or

different?

```
>>> class Thing :
... pass
...
>>> print (Thing)
<class '__main__.Thing'>
>>> example = Thing()
>>> print (example)
<__main__.Thing object at 0x1006f3fd0>
```
10.2 Make a new class called Thing2 and assign the value 'abc' to a class variable

called letters. Print letters.

```
>>> class Thing2 :
... letters = 'abc'
...
>>> print (Thing2.letters)
abc
```
**546 | Appendix D: Answers to Exercises**


10.3 Make yet another class called (of course) Thing3. This time, assign the value

'xyz' to an instance (object) variable called letters. Print letters. Do you need to

make an object from the class to do this?

```
>>> class Thing3 :
... def __init__(self):
... self.letters = 'xyz'
...
```
```
The variable letters belongs to any objects made from Thing3, not the Thing3 class
itself:
```
```
>>> print (Thing3.letters)
Traceback (most recent call last):
File "<stdin>", line 1, in <module>
AttributeError: type object 'Thing3' has no attribute 'letters'
>>> something = Thing3()
>>> print (something.letters)
xyz
```
10.4 Make a class called Element, with instance attributes name, symbol, and number.

Create an object called hydrogen of this class with the values 'Hydrogen', 'H', and 1.

```
>>> class Element :
... def __init__(self, name, symbol, number):
... self.name = name
... self.symbol = symbol
... self.number = number
...
>>> hydrogen = Element('Hydrogen', 'H', 1)
```
10.5 Make a dictionary with these keys and values: 'name': 'Hydrogen', 'symbol':

'H', 'number': 1. Then, create an object called hydrogen from class Element using

this dictionary.

```
Start with the dictionary:
```
```
>>> el_dict = {'name': 'Hydrogen', 'symbol': 'H', 'number': 1}
```
```
This works, although it takes a bit of typing:
```
```
>>> hydrogen = Element(el_dict['name'], el_dict['symbol'], el_dict['number'])
```
```
Let’s check that it worked:
```
```
Answers to Exercises | 547
```

```
>>> hydrogen.name
'Hydrogen'
```
```
However, you can also initialize the object directly from the dictionary, because its
key names match the arguments to __init__ (refer to Chapter 9 for a discussion of
keyword arguments):
```
```
>>> hydrogen = Element(**el_dict)
>>> hydrogen.name
'Hydrogen'
```
10.6 For the Element class, define a method called dump() that prints the values of the

object’s attributes (name, symbol, and number). Create the hydrogen object from this

new definition and use dump() to print its attributes.

```
>>> class Element :
... def __init__(self, name, symbol, number):
... self.name = name
... self.symbol = symbol
... self.number = number
... def dump(self):
... print ('name=%s, symbol=%s, number=%s' %
... (self.name, self.symbol, self.number))
...
>>> hydrogen = Element(**el_dict)
>>> hydrogen.dump()
name=Hydrogen, symbol=H, number=1
```
10.7 Call print(hydrogen). In the definition of Element, change the name of the

method dump to __str__, create a new hydrogen object, and call print(hydrogen)

again.

```
>>> print (hydrogen)
<__main__.Element object at 0x1006f5310>
>>> class Element :
... def __init__(self, name, symbol, number):
... self.name = name
... self.symbol = symbol
... self.number = number
... def __str__(self):
... return ('name=%s, symbol=%s, number=%s' %
... (self.name, self.symbol, self.number))
...
>>> hydrogen = Element(**el_dict)
>>> print (hydrogen)
name=Hydrogen, symbol=H, number=1
```
**548 | Appendix D: Answers to Exercises**


```
__str__() is one of Python’s magic methods. The print function calls an object’s
__str__() method to get its string representation. If it doesn’t have a __str__()
method, it gets the default method from its parent Object class, which returns a
string like <__main__.Element object at 0x1006f5310>.
```
10.8 Modify Element to make the attributes name, symbol, and number private. Define

a getter property for each to return its value.

```
>>> class Element :
... def __init__(self, name, symbol, number):
... self.__name = name
... self.__symbol = symbol
... self.__number = number
... @property
... def name(self):
... return self.__name
... @property
... def symbol(self):
... return self.__symbol
... @property
... def number(self):
... return self.__number
...
>>> hydrogen = Element('Hydrogen', 'H', 1)
>>> hydrogen.name
'Hydrogen'
>>> hydrogen.symbol
'H'
>>> hydrogen.number
1
```
10.9 Define three classes: Bear, Rabbit, and Octothorpe. For each, define only one

method: eats(). This should return 'berries' (Bear), 'clover' (Rabbit), and

'campers' (Octothorpe). Create one object from each and print what it eats.

```
>> class Bear:
... def eats(self):
... return 'berries'
...
>>> class Rabbit :
... def eats(self):
... return 'clover'
...
>>> class Octothorpe :
... def eats(self):
```
```
Answers to Exercises | 549
```

```
... return 'campers'
...
>>> b = Bear()
>>> r = Rabbit()
>>> o = Octothorpe()
>>> print (b.eats())
berries
>>> print (r.eats())
clover
>>> print (o.eats())
campers
```
10.10 Define these classes: Laser, Claw, and SmartPhone. Each has only one method:

does(). This returns 'disintegrate' (Laser), 'crush' (Claw), or 'ring' (Smart

Phone). Then, define the class Robot that has one instance (object) of each of these.

Define a does() method for the Robot that prints what its component objects do.

```
>>> class Laser :
... def does(self):
... return 'disintegrate'
...
>>> class Claw :
... def does(self):
... return 'crush'
...
>>> class SmartPhone :
... def does(self):
... return 'ring'
...
>>> class Robot :
... def __init__(self):
... self.laser = Laser()
... self.claw = Claw()
... self.smartphone = SmartPhone()
... def does(self):
... return '''I have many attachments:
... My laser, to %s.
... My claw, to %s.
... My smartphone, to %s.''' % (
... self.laser.does(),
... self.claw.does(),
... self.smartphone.does() )
...
>>> robbie = Robot()
>>> print ( robbie.does() )
I have many attachments:
My laser, to disintegrate.
```
**550 | Appendix D: Answers to Exercises**


```
My claw, to crush.
My smartphone, to ring.
```
### 11. Modules, Packages, and Goodies

11.1 Make a file called zoo.py. In it, define a function called hours that prints the

string 'Open 9-5 daily'. Then, use the interactive interpreter to import the zoo

module and call its hours function.

```
Here’s zoo.py:
```
```
def hours():
print ('Open 9-5 daily')
```
```
And now, let’s import it interactively:
```
```
>>> import zoo
>>> zoo.hours()
Open 9-5 daily
```
11.2 In the interactive interpreter, import the zoo module as menagerie and call its

hours() function.

```
>>> import zoo as menagerie
>>> menagerie.hours()
Open 9-5 daily
```
11.3 Staying in the interpreter, import the hours() function from zoo directly and call

it.

```
>>> from zoo import hours
>>> hours()
Open 9-5 daily
```
11.4 Import the hours() function as info and call it.

```
>>> from zoo import hours as info
>>> info()
Open 9-5 daily
```
```
Answers to Exercises | 551
```

11.6 Make an OrderedDict called fancy from the same pairs and print it. Did it print

in the same order as plain?

```
>>> from collections import OrderedDict
>>> fancy = OrderedDict([('a', 1), ('b', 2), ('c', 3)])
>>> fancy
OrderedDict([('a', 1), ('b', 2), ('c', 3)])
```
11.7 Make a defaultdict called dict_of_lists and pass it the argument list. Make

the list dict_of_lists['a'] and append the value 'something for a' to it in one

assignment. Print dict_of_lists['a'].

```
>>> from collections import defaultdict
>>> dict_of_lists = defaultdict(list)
>>> dict_of_lists['a'].append('something for a')
>>> dict_of_lists['a']
['something for a']
```
### 12. Wrangle and Mangle Data

12.1 Create a Unicode string called mystery and assign it the value '\U0001f984'.

Print mystery and its Unicode name.

```
>>> import unicodedata
>>> mystery = ' \U0001f4a9 '
>>> mystery
'💩'
>>> unicodedata.name(mystery)
'PILE OF POO'
```
```
Oh my. What else have they got in there?
```
12.2 Encode mystery, this time using UTF-8, into the bytes variable popbytes. Print

pop_bytes.

```
>>> pop_bytes = mystery.encode('utf-8')
>>> pop_bytes
b'\xf0\x9f\x92\xa9'
```
**552 | Appendix D: Answers to Exercises**


12.3 Using UTF-8, decode popbytes into the string variable pop_string. Print

pop_string. Is pop_string equal to mystery?

```
>>> pop_string = pop_bytes.decode('utf-8')
>>> pop_string
'💩'
>>> pop_string == mystery
True
```
12.4 When you’re working with text, regular expressions come in very handy. We’ll

apply them in a number of ways to our featured text sample. It’s a poem titled “Ode

on the Mammoth Cheese,” written by James McIntyre in 1866 in homage to a seven-

thousand-pound cheese that was crafted in Ontario and sent on an international tour.

If you’d rather not type all of it, use your favorite search engine and cut and paste the

words into your Python program, or just grab it from Project Gutenberg. Call the text

string mammoth.

```
>>> mammoth = '''
... We have seen thee, queen of cheese,
... Lying quietly at your ease,
... Gently fanned by evening breeze,
... Thy fair form no flies dare seize.
...
... All gaily dressed soon you'll go
... To the great Provincial show,
... To be admired by many a beau
... In the city of Toronto.
...
... Cows numerous as a swarm of bees,
... Or as the leaves upon the trees,
... It did require to make thee please,
... And stand unrivalled, queen of cheese.
...
... May you not receive a scar as
... We have heard that Mr. Harris
... Intends to send you off as far as
... The great world's show at Paris.
...
... Of the youth beware of these,
... For some of them might rudely squeeze
... And bite your cheek, then songs or glees
... We could not sing, oh! queen of cheese.
...
... We'rt thou suspended from balloon,
... You'd cast a shade even at noon,
... Folks would think it was the moon
```
```
Answers to Exercises | 553
```

```
... About to fall and crush them soon.
... '''
```
12.5 Import the re module to use Python’s regular expression functions. Use the

re.findall() to print all the words that begin with c.

```
We’ll define the variable pat for the pattern and then search for it in mammoth:
```
```
>>> import re
>>> pat = r'\bc\w*'
>>> re.findall(pat, mammoth)
['cheese', 'city', 'cheese', 'cheek', 'could', 'cheese', 'cast', 'crush']
```
```
The \b means to begin at a boundary between a word and a nonword. Use this to
specify either the beginning or end of a word. The literal c is the first letter of the
words we’re looking for. The \w means any word character, which includes letters, dig‐
its, and underscores (_). The * means zero or more of these word characters. Together,
this finds words that begin with c, including 'c' itself. If you didn’t use a raw string
(with an r right before the starting quote), Python would interpret \b as a backspace
and the search would mysteriously fail:
```
```
>>> pat = ' \b c\w*'
>>> re.findall(pat, mammoth)
[]
```
12.6 Find all four-letter words that begin with c.

```
>>> pat = r'\bc\w{3}\b'
>>> re.findall(pat, mammoth)
['city', 'cast']
```
```
You need that final \b to indicate the end of the word. Otherwise, you’ll get the first
four letters of all words that begin with c and have at least four letters:
```
```
>>> pat = r'\bc\w{3}'
>>> re.findall(pat, mammoth)
['chee', 'city', 'chee', 'chee', 'coul', 'chee', 'cast', 'crus']
```
12.7 Find all the words that end with r.

```
This is a little tricky. We get the right result for words that end with r:
```
**554 | Appendix D: Answers to Exercises**


```
>>> pat = r'\b\w*r\b'
>>> re.findall(pat, mammoth)
['your', 'fair', 'Or', 'scar', 'Mr', 'far', 'For', 'your', 'or']
```
```
However, the results aren’t so good for words that end with l:
```
```
>>> pat = r'\b\w*l\b'
>>> re.findall(pat, mammoth)
['All', 'll', 'Provincial', 'fall']
```
```
But what’s that ll doing there? The \w pattern matches only letters, numbers, and
underscores—not ASCII apostrophes. As a result, it grabs the final ll from you'll.
We can handle this by adding an apostrophe to the set of characters to match. Our
first try fails:
```
```
>>> pat = r'\b[\w']*l\b'
File "<stdin>", line 1
pat = r'\b[\w']*l\b'
```
```
Python points to the vicinity of the error, but it might take a while to see that the mis‐
take was that the pattern string is surrounded by the same apostrophe/quote charac‐
ter. One way to solve this is to escape it with a backslash:
```
```
>>> pat = r'\b[\w \' ]*l\b'
>>> re.findall(pat, mammoth)
['All', "you'll", 'Provincial', 'fall']
```
```
Another way is to surround the pattern string with double quotes:
```
```
>>> pat = r"\b[\w']*l\b"
>>> re.findall(pat, mammoth)
['All', "you'll", 'Provincial', 'fall']
```
12.8 Find all the words that contain exactly three vowels in a row.

```
Begin with a word boundary, any number of word characters, three vowels, and then
any nonvowel characters to the end of the word:
```
```
>>> pat = r'\b[^aeiou]*[aeiou]{3}[^aeiou]*\b'
>>> re.findall(pat, mammoth)
['queen', 'quietly', 'beau\nIn', 'queen', 'squeeze', 'queen']
```
```
This looks right, except for that 'beau\nIn' string. We searched mammoth as a single
multiline string. Our [^aeiou] matches any nonvowels, including \n (line feed, which
marks the end of a text line). We need to add one more thing to the ignore set: \s
matches any space characters, including \n:
```
```
>>> pat = r'\b\w*[aeiou]{3}[^aeiou\s]\w*\b'
>>> re.findall(pat, mammoth)
['queen', 'quietly', 'queen', 'squeeze', 'queen']
```
```
Answers to Exercises | 555
```

```
We didn’t find beau this time, so we need one more tweak to the pattern: match any
number (even zero) of nonvowels after the three vowels. Our previous pattern always
matched one nonvowel.
```
```
>>> pat = r'\b\w*[aeiou]{3}[^aeiou\s]*\w*\b'
>>> re.findall(pat, mammoth)
['queen', 'quietly', 'beau', 'queen', 'squeeze', 'queen']
```
```
What does all of this show? Among other things, that regular expressions can do a lot,
but they can be very tricky to get right.
```
12.9 Use unhexlify() to convert this hex string (combined from two strings to fit on

a page) to a bytes variable called gif:

```
'47494638396101000100800000000000ffffff21f9' +
'0401000000002c000000000100010000020144003b'
```
```
>>> import binascii
>>> hex_str = '47494638396101000100800000000000ffffff21f9' + \
... '0401000000002c000000000100010000020144003b'
>>> gif = binascii.unhexlify(hex_str)
>>> len(gif)
42
```
12.10 The bytes in gif define a one-pixel transparent GIF file, one of the most com‐

mon graphics file formats. A legal GIF starts with the string GIF89a. Does gif match

this?

```
>>> gif[:6] == b'GIF89a'
True
```
```
Notice that we needed to use a b to define a byte string rather than a Unicode charac‐
ter string. You can compare bytes with bytes, but you cannot compare bytes with
strings:
```
```
>>> gif[:6] == 'GIF89a'
False
>>> type(gif)
<class 'bytes'>
>>> type('GIF89a')
<class 'str'>
>>> type(b'GIF89a')
<class 'bytes'>
```
**556 | Appendix D: Answers to Exercises**


12.11 The pixel width of a GIF is a 16-bit little-endian integer starting at byte offset 6,

and the height is the same size, starting at offset 8. Extract and print these values for

gif. Are they both 1?

```
>>> import struct
>>> width, height = struct.unpack('<HH', gif[6:10])
>>> width, height
(1, 1)
```
### 13. Calendars and Clocks

13.1 Write the current date as a string to the text file today.txt.

```
>>> from datetime import date
>>> now = date.today()
>>> now_str = now.isoformat()
>>> with open('today.txt', 'wt') as output:
... print (now_str, file=output)
>>>
```
```
When I ran this, here’s what I got in today.txt:
```
```
2019-07-23
```
```
Instead of print, you could have also said something like output.write(now_str).
Using print adds the final newline.
```
13.2 Read the text file today.txt into the string today_string.

```
>>> with open('today.txt', 'rt') as input:
... today_string = input.read()
...
>>> today_string
'2019-07-23\n'
```
13.3 Parse the date from today_string.

```
>>> fmt = '%Y-%m-%d \n '
>>> datetime.strptime(today_string, fmt)
datetime.datetime(2019, 7, 23, 0, 0)
```
```
Answers to Exercises | 557
```

```
If you wrote that final newline to the file, you need to match it in the format string.
```
13.4 Create a date object of your day of birth.

```
Let’s say that you were born on August 14, 1982:
```
```
>>> my_day = date(1982, 8, 14)
>>> my_day
datetime.date(1982, 8, 14)
```
13.5 What day of the week was your day of birth?

```
>>> my_day.weekday()
5
>>> my_day.isoweekday()
6
```
```
With weekday(), Monday is 0 and Sunday is 6. With isoweekday(), Monday is 1 and
Sunday is 7. Therefore, this date was a Saturday.
```
13.6 When will you be (or when were you) 10,000 days old?

```
>>> from datetime import timedelta
>>> party_day = my_day + timedelta(days=10000)
>>> party_day
datetime.date(2009, 12, 30)
```
```
If August 14, 1982 was your birthday, you probably missed an excuse for a party.
```
### 14. Files and Directories

14.1 List the files in your current directory.

```
If your current directory is ohmy and contains three files named after animals, it
might look like this:
```
```
>>> import os
>>> os.listdir('.')
['bears', 'lions', 'tigers']
```
**558 | Appendix D: Answers to Exercises**


14.2 List the files in your parent directory.

```
If your parent directory contained two files plus the current ohmy directory, it might
look like this:
```
```
>>> import os
>>> os.listdir('..')
['ohmy', 'paws', 'whiskers']
```
14.3 Assign the string 'This is a test of the emergency text system' to the

variable test1, nd write test1 to a file called test.txt.

```
>>> test1 = 'This is a test of the emergency text system'
>>> len(test1)
43
```
```
Here’s how to do it by using open, write, and close:
```
```
>>> outfile = open('test.txt', 'wt')
>>> outfile.write(test1)
43
>>> outfile.close()
```
```
Or, you can use with and avoid calling close (Python does it for you):
```
```
>>> with open('test.txt', 'wt') as outfile:
... outfile.write(test1)
...
43
```
14.4 Open the file test.txt and read its contents into the string test2. Are test1 and

test2 the same?

```
>>> with open('test.txt', 'rt') as infile:
... test2 = infile.read()
...
>>> len(test2)
43
>>> test1 == test2
True
```
```
Answers to Exercises | 559
```

### 15. Data in Time: Processes and Concurrency

15.1 Use multiprocessing to create three separate processes. Make each one wait a

random number of seconds between zero and one, print the current time, and then

exit.

```
import multiprocessing
```
```
def now(seconds):
from datetime import datetime
from time import sleep
sleep(seconds)
print ('wait', seconds, 'seconds, time is', datetime.utcnow())
```
```
if __name__ == '__main__':
import random
for n in range(3):
seconds = random.random()
proc = multiprocessing.Process(target=now, args=(seconds,))
proc.start()
```
```
$ python multi_times.py
wait 0.10720361113059229 seconds, time is 2019-07-24 00:19:23.951594
wait 0.5825144002370065 seconds, time is 2019-07-24 00:19:24.425047
wait 0.6647690569029477 seconds, time is 2019-07-24 00:19:24.509995
```
### 16. Data in a Box: Persistent Storage

16.1 Save the following text lines to a file called books.csv (notice that if the fields are

separated by commas, you need to surround a field with quotes if it contains a

comma):

```
author,book
J R R Tolkien,The Hobbit
Lynne Truss,"Eats, Shoots & Leaves"
```
```
>>> text = '''author,book
... J R R Tolkien,The Hobbit
... Lynne Truss,"Eats, Shoots & Leaves"
... '''
>>> with open('test.csv', 'wt') as outfile:
... outfile.write(text)
...
73
```
**560 | Appendix D: Answers to Exercises**


16.2 Use the csv module and its DictReader method to read books.csv to the variable

books. Print the values in books. Did DictReader handle the quotes and commas in

the second book’s title?

```
>>> with open('books.csv', 'rt') as infile:
... books = csv.DictReader(infile)
... for book in books:
... print (book)
...
{'book': 'The Hobbit', 'author': 'J R R Tolkien'}
{'book': 'Eats, Shoots & Leaves', 'author': 'Lynne Truss'}
```
16.3 Create a CSV file called books2.csv by using these lines:

```
title,author,year
The Weirdstone of Brisingamen,Alan Garner,1960
Perdido Street Station,China Miéville,2000
Thud!,Terry Pratchett,2005
The Spellman Files,Lisa Lutz,2007
Small Gods,Terry Pratchett,1992
```
```
>>> text = '''title,author,year
... The Weirdstone of Brisingamen,Alan Garner,1960
... Perdido Street Station,China Miéville,2000
... Thud!,Terry Pratchett,2005
... The Spellman Files,Lisa Lutz,2007
... Small Gods,Terry Pratchett,1992
... '''
>>> with open('books2.csv', 'wt') as outfile:
... outfile.write(text)
...
201
```
16.4 Use the sqlite3 module to create a SQLite database called books.db and a table

called books with these fields: title (text), author (text), and year (integer).

```
>>> import sqlite3
>>> db = sqlite3.connect('books.db')
>>> curs = db.cursor()
>>> curs.execute('''create table book (title text, author text, year int)''')
<sqlite3.Cursor object at 0x1006e3b90>
>>> db.commit()
```
```
Answers to Exercises | 561
```

16.5 Read books2.csv and insert its data into the book table.

```
>>> import csv
>>> import sqlite3
>>> ins_str = 'insert into book values(?, ?, ?)'
>>> with open('books.csv', 'rt') as infile:
... books = csv.DictReader(infile)
... for book in books:
... curs.execute(ins_str, (book['title'], book['author'], book['year']))
...
<sqlite3.Cursor object at 0x1007b21f0>
<sqlite3.Cursor object at 0x1007b21f0>
<sqlite3.Cursor object at 0x1007b21f0>
<sqlite3.Cursor object at 0x1007b21f0>
<sqlite3.Cursor object at 0x1007b21f0>
>>> db.commit()
```
16.6 Select and print the title column from the book table in alphabetical order.

```
>>> sql = 'select title from book order by title asc'
>>> for row in db.execute(sql):
... print (row)
...
('Perdido Street Station',)
('Small Gods',)
('The Spellman Files',)
('The Weirdstone of Brisingamen',)
('Thud!',)
```
```
If you just wanted to print the title value without that tuple stuff (parentheses and
comma), try this:
```
```
>>> for row in db.execute(sql):
... print (row[0])
...
Perdido Street Station
Small Gods
The Spellman Files
The Weirdstone of Brisingamen
Thud!
```
```
If you want to ignore the initial 'The' in titles, you need a little extra SQL fairy dust:
```
```
>>> sql = '''select title from book order by
... case when (title like "The %")
... then substr(title, 5)
... else title end'''
>>> for row in db.execute(sql):
... print (row[0])
```
**562 | Appendix D: Answers to Exercises**


##### ...

```
Perdido Street Station
Small Gods
The Spellman Files
Thud!
The Weirdstone of Brisingamen
```
16.7 Select and print all columns from the book table in order of publication.

```
>>> for row in db.execute('select * from book order by year'):
... print (row)
...
('The Weirdstone of Brisingamen', 'Alan Garner', 1960)
('Small Gods', 'Terry Pratchett', 1992)
('Perdido Street Station', 'China Miéville', 2000)
('Thud!', 'Terry Pratchett', 2005)
('The Spellman Files', 'Lisa Lutz', 2007)
```
```
To print all the fields in each row, just separate with a comma and space:
```
```
>>> for row in db.execute('select * from book order by year'):
... print (*row, sep=', ')
...
The Weirdstone of Brisingamen, Alan Garner, 1960
Small Gods, Terry Pratchett, 1992
Perdido Street Station, China Miéville, 2000
Thud!, Terry Pratchett, 2005
The Spellman Files, Lisa Lutz, 2007
```
16.8 Use the sqlalchemy module to connect to the sqlite3 database books.db that you

just made in exercise 8.6. As in 8.8, select and print the title column from the book

table in alphabetical order.

```
>>> import sqlalchemy
>>> conn = sqlalchemy.create_engine('sqlite:///books.db')
>>> sql = 'select title from book order by title asc'
>>> rows = conn.execute(sql)
>>> for row in rows:
... print (row)
...
('Perdido Street Station',)
('Small Gods',)
('The Spellman Files',)
('The Weirdstone of Brisingamen',)
('Thud!',)
```
```
Answers to Exercises | 563
```

16.9 Install the Redis server (see Appendix B) and the Python redis library (pip

install redis) on your machine. Create a Redis hash called test with the fields

count ( 1 ) and name ('Fester Bestertester'). Print all the fields for test.

```
>>> import redis
>>> conn = redis.Redis()
>>> conn.delete('test')
1
>>> conn.hmset('test', {'count': 1, 'name': 'Fester Bestertester'})
True
>>> conn.hgetall('test')
{b'name': b'Fester Bestertester', b'count': b'1'}
```
16.10 Increment the count field of test and print it.

```
>>> conn.hincrby('test', 'count', 3)
4
>>> conn.hget('test', 'count')
b'4'
```
### 17. Data in Space: Networks

17.1 Use a plain socket to implement a current-time service. When a client sends the

string 'time' to the server, return the current date and time as an ISO string.

```
Here’s one way to write the server, udp_time_server.py:
```
```
from datetime import datetime
import socket
```
```
address = ('localhost', 6789)
max_size = 4096
```
```
print ('Starting the server at', datetime.now())
print ('Waiting for a client to call.')
server = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
server.bind(address)
while True:
data, client_addr = server.recvfrom(max_size)
if data == b'time':
now = str(datetime.utcnow())
data = now.encode('utf-8')
server.sendto(data, client_addr)
```
**564 | Appendix D: Answers to Exercises**


```
print ('Server sent', data)
server.close()
```
```
And the client, udp_time_client.py:
```
```
import socket
from datetime import datetime
from time import sleep
```
```
address = ('localhost', 6789)
max_size = 4096
```
```
print ('Starting the client at', datetime.now())
client = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
while True:
sleep(5)
client.sendto(b'time', address)
data, server_addr = client.recvfrom(max_size)
print ('Client read', data)
client.close()
```
```
I put in a sleep(5) call at the top of the client loop to make the data exchange less
supersonic. Start the server in one window:
```
```
$ python udp_time_server.py
Starting the server at 2014-06-02 20:28:47.415176
Waiting for a client to call.
```
```
Start the client in another window:
```
```
$ python udp_time_client.py
Starting the client at 2014-06-02 20:28:51.454805
```
```
After five seconds, you’ll start getting output in both windows. Here are the first three
lines from the server:
```
```
Server sent b'2014-06-03 01:28:56.462565'
Server sent b'2014-06-03 01:29:01.463906'
Server sent b'2014-06-03 01:29:06.465802'
```
```
And here are the first three from the client:
```
```
Client read b'2014-06-03 01:28:56.462565'
Client read b'2014-06-03 01:29:01.463906'
Client read b'2014-06-03 01:29:06.465802'
```
```
Both of these programs run forever, so you’ll need to cancel them manually.
```
17.2. Use ZeroMQ REQ and REP sockets to do the same thing.

```
import zmq
from datetime import datetime
```
```
Answers to Exercises | 565
```

```
host = '127.0.0.1'
port = 6789
context = zmq.Context()
server = context.socket(zmq.REP)
server.bind("tcp://%s:%s" % (host, port))
print ('Server started at', datetime.utcnow())
while True:
# Wait for next request from client
message = server.recv()
if message == b'time':
now = datetime.utcnow()
reply = str(now)
server.send(bytes(reply, 'utf-8'))
print ('Server sent', reply)
```
```
import zmq
from datetime import datetime
from time import sleep
```
```
host = '127.0.0.1'
port = 6789
context = zmq.Context()
client = context.socket(zmq.REQ)
client.connect("tcp://%s:%s" % (host, port))
print ('Client started at', datetime.utcnow())
while True:
sleep(5)
request = b'time'
client.send(request)
reply = client.recv()
print ("Client received %s" % reply)
```
```
With plain sockets, you need to start the server first. With ZeroMQ, you can start
either the server or client first.
```
```
$ python zmq_time_server.py
Server started at 2014-06-03 01:39:36.933532
```
```
$ python zmq_time_client.py
Client started at 2014-06-03 01:39:42.538245
```
```
After 15 seconds or so, you should have some lines from the server:
```
```
Server sent 2014-06-03 01:39:47.539878
Server sent 2014-06-03 01:39:52.540659
Server sent 2014-06-03 01:39:57.541403
```
```
Here’s what you should see from the client:
```
```
Client received b'2014-06-03 01:39:47.539878'
Client received b'2014-06-03 01:39:52.540659'
Client received b'2014-06-03 01:39:57.541403'
```
**566 | Appendix D: Answers to Exercises**


17.3. Try the same with XMLRPC.

```
From the server:
```
```
from xmlrpc.server import SimpleXMLRPCServer
```
```
def now():
from datetime import datetime
data = str(datetime.utcnow())
print ('Server sent', data)
return data
```
```
server = SimpleXMLRPCServer(("localhost", 6789))
server.register_function(now, "now")
server.serve_forever()
```
```
And from the client:
```
```
import xmlrpc.client
from time import sleep
```
```
proxy = xmlrpc.client.ServerProxy("http://localhost:6789/")
while True:
sleep(5)
data = proxy.now()
print ('Client received', data)
```
```
Start the server:
```
```
$ python xmlrpc_time_server.py
```
```
Start the client:
```
```
$ python xmlrpc_time_client.py
```
```
Wait 15 seconds or so. Here are the first three lines of server output:
```
```
Server sent 2014-06-03 02:14:52.299122
127.0.0.1 - - [02/Jun/2014 21:14:52] "POST / HTTP/1.1" 200 -
Server sent 2014-06-03 02:14:57.304741
127.0.0.1 - - [02/Jun/2014 21:14:57] "POST / HTTP/1.1" 200 -
Server sent 2014-06-03 02:15:02.310377
127.0.0.1 - - [02/Jun/2014 21:15:02] "POST / HTTP/1.1" 200 -
```
```
And here are the first three lines from the client:
```
```
Client received 2014-06-03 02:14:52.299122
Client received 2014-06-03 02:14:57.304741
Client received 2014-06-03 02:15:02.310377
```
```
Answers to Exercises | 567
```

17.4 You may have seen the classic I Love Lucy television episode in which Lucy and

Ethel worked in a chocolate factory. The duo fell behind as the conveyor belt that

supplied the confections for them to process began operating at an ever-faster rate.

Write a simulation that pushes different types of chocolates to a Redis list, and Lucy is

a client doing blocking pops of this list. She needs 0.5 seconds to handle a piece of

chocolate. Print the time and type of each chocolate as Lucy gets it, and how many

remain to be handled.

```
redis_choc_supply.py supplies the infinite treats:
```
```
import redis
import random
from time import sleep
```
```
conn = redis.Redis()
varieties = ['truffle', 'cherry', 'caramel', 'nougat']
conveyor = 'chocolates'
while True:
seconds = random.random()
sleep(seconds)
piece = random.choice(varieties)
conn.rpush(conveyor, piece)
```
```
redis_lucy.py might look like this:
```
```
import redis
from datetime import datetime
from time import sleep
```
```
conn = redis.Redis()
timeout = 10
conveyor = 'chocolates'
while True:
sleep(0.5)
msg = conn.blpop(conveyor, timeout)
remaining = conn.llen(conveyor)
if msg:
piece = msg[1]
print ('Lucy got a', piece, 'at', datetime.utcnow(),
', only', remaining, 'left')
```
```
Start them in either order. Because Lucy takes a half second to handle each, and
they’re being produced every half second on average, it’s a race to keep up. The more
of a head start that you give to the conveyor belt, the harder you make Lucy’s life.
```
```
$ python redis_choc_supply.py &
```
```
$ python redis_lucy.py
Lucy got a b'nougat' at 2014-06-03 03:15:08.721169 , only 4 left
Lucy got a b'cherry' at 2014-06-03 03:15:09.222816 , only 3 left
Lucy got a b'truffle' at 2014-06-03 03:15:09.723691 , only 5 left
```
**568 | Appendix D: Answers to Exercises**


```
Lucy got a b'truffle' at 2014-06-03 03:15:10.225008 , only 4 left
Lucy got a b'cherry' at 2014-06-03 03:15:10.727107 , only 4 left
Lucy got a b'cherry' at 2014-06-03 03:15:11.228226 , only 5 left
Lucy got a b'cherry' at 2014-06-03 03:15:11.729735 , only 4 left
Lucy got a b'truffle' at 2014-06-03 03:15:12.230894 , only 6 left
Lucy got a b'caramel' at 2014-06-03 03:15:12.732777 , only 7 left
Lucy got a b'cherry' at 2014-06-03 03:15:13.234785 , only 6 left
Lucy got a b'cherry' at 2014-06-03 03:15:13.736103 , only 7 left
Lucy got a b'caramel' at 2014-06-03 03:15:14.238152 , only 9 left
Lucy got a b'cherry' at 2014-06-03 03:15:14.739561 , only 8 left
```
```
Poor Lucy.
```
17.5 Use ZeroMQ to publish the poem from exercise 12.4 (from Example 12-1), one

word at a time. Write a ZeroMQ consumer that prints every word that starts with a

vowel, and another that prints every word that contains five letters. Ignore punctua‐

tion characters.

```
Here’s the server, poem_pub.py, which plucks each word from the poem and publishes
it to the topic vowels if it starts with a vowel, and the topic five if it has five letters.
Some words might be in both topics, some in neither.
```
```
import string
import zmq
```
```
host = '127.0.0.1'
port = 6789
ctx = zmq.Context()
pub = ctx.socket(zmq.PUB)
pub.bind('tcp://%s:%s' % (host, port))
```
```
with open('mammoth.txt', 'rt') as poem:
words = poem.read()
for word in words.split():
word = word.strip(string.punctuation)
data = word.encode('utf-8')
if word.startswith(('a','e','i','o','u','A','e','i','o','u')):
pub.send_multipart([b'vowels', data])
if len(word) == 5:
pub.send_multipart([b'five', data])
```
```
The client, poem_sub.py, subscribes to the topics vowels and five and prints the topic
and word:
```
```
import string
import zmq
```
```
host = '127.0.0.1'
port = 6789
```
```
Answers to Exercises | 569
```

```
ctx = zmq.Context()
sub = ctx.socket(zmq.SUB)
sub.connect('tcp://%s:%s' % (host, port))
sub.setsockopt(zmq.SUBSCRIBE, b'vowels')
sub.setsockopt(zmq.SUBSCRIBE, b'five')
while True:
topic, word = sub.recv_multipart()
print (topic, word)
```
```
If you start these and run them, they almost work. Your code looks fine but nothing
happens. You need to read the ZeroMQ guide to learn about the slow joiner problem:
even if you start the client before the server, the server begins pushing data immedi‐
ately after starting, and the client takes a little time to connect to the server. If you’re
publishing a constant stream of something and don’t really care when the subscribers
jump in, it’s no problem. But in this case, the data stream is so short that it’s flown
past before the subscriber blinks, like a fastball past a batter.
```
```
The easiest way to fix this is to make the publisher sleep a second after it calls bind()
and before it starts sending messages. Call this version poem_pub_sleep.py:
```
```
import string
import zmq
from time import sleep
```
```
host = '127.0.0.1'
port = 6789
ctx = zmq.Context()
pub = ctx.socket(zmq.PUB)
pub.bind('tcp://%s:%s' % (host, port))
```
```
sleep(1)
```
```
with open('mammoth.txt', 'rt') as poem:
words = poem.read()
for word in words.split():
word = word.strip(string.punctuation)
data = word.encode('utf-8')
if word.startswith(('a','e','i','o','u','A','e','i','o','u')):
print ('vowels', data)
pub.send_multipart([b'vowels', data])
if len(word) == 5:
print ('five', data)
pub.send_multipart([b'five', data])
```
```
Start the subscriber and then the sleepy publisher:
```
```
$ python poem_sub.py
```
```
$ python poem_pub_sleep.py
```
```
Now, the subscriber has time to grab its two topics. Here are the first few lines of its
output:
```
**570 | Appendix D: Answers to Exercises**


```
b'five' b'queen'
b'vowels' b'of'
b'five' b'Lying'
b'vowels' b'at'
b'vowels' b'ease'
b'vowels' b'evening'
b'five' b'flies'
b'five' b'seize'
b'vowels' b'All'
b'five' b'gaily'
b'five' b'great'
b'vowels' b'admired'
```
```
If you can’t add a sleep() to your publisher, you can synchronize publisher and sub‐
scriber programs by using REQ and REP sockets. See the publisher.py and subscriber.py
examples on GitHub.
```
### 18. The Web, Untangled

18.1 If you haven’t installed flask yet, do so now. This will also install werkzeug,

jinja2, and possibly other packages.

18.2 Build a skeleton website, using Flask’s debug/reload development web server.

Ensure that the server starts up for hostname localhost on default port 5000. If your

machine is already using port 5000 for something else, use another port number.

```
Here’s flask1.py:
```
```
from flask import Flask
```
```
app = Flask( __name__ )
```
```
app.run(port=5000, debug=True)
```
```
Gentlemen, start your engines:
```
```
$ python flask1.py
* Running on http://127.0.0.1:5000/
* Restarting with reloader
```
18.3 Add a home() function to handle requests for the home page. Set it up to return

the string It's alive!.

```
What should we call this one, flask2.py?
```
```
Answers to Exercises | 571
```

```
from flask import Flask
```
```
app = Flask( __name__ )
```
```
@app.route('/')
def home():
return "It's alive!"
```
```
app.run(debug=True)
```
```
Start the server:
```
```
$ python flask2.py
* Running on http://127.0.0.1:5000/
* Restarting with reloader
```
```
Finally, access the home page via a browser, command-line HTTP program such as
curl or wget, or even telnet:
```
```
$ curl http://localhost:5000/
It's alive!
```
18.4 Create a Jinja2 template file called home.html with the following contents:

```
I'm of course referring to {{thing}},
which is {{height}} feet tall and {{color}}.
```
Make a directory called templates and create the file home.html with the contents just

shown. If your Flask server is still running from the previous examples, it will detect

the new content and restart itself.

18.5 Modify your server’s home() function to use the home.html template. Provide it

with three GET parameters: thing, height, and color.

```
Here comes flask3.py:
```
```
from flask import Flask, request, render_template
```
```
app = Flask( __name__ )
```
```
@app.route('/')
def home():
thing = request.values.get('thing')
height = request.values.get('height')
color = request.values.get('color')
return render_template('home.html',
thing=thing, height=height, color=color)
```
```
app.run(debug=True)
```
```
Go to this address in your web client:
```
**572 | Appendix D: Answers to Exercises**


```
http://localhost:5000/?thing=Octothorpe&height=7&color=green
```
```
You should see the following:
```
```
I'm of course referring to Octothorpe, which is 7 feet tall and green.
```
### 19. Be a Pythonista

(Pythonistas don’t have homework today.)

### 20. Py Art

20.1 Install matplotlib. Draw a scatter diagram of these (x, y) pairs: ( (0, 0), (3,

5), (6, 2), (9, 8), (14, 10) ).

20.2 Draw a line graph of the same data.

20.3 Draw a plot (a line graph with markers) of the same data

```
This has all three as subplots:
```
```
import matplotlib.pyplot as plt
```
```
x = (0, 3, 6, 9, 14)
y = (0, 5, 2, 8, 10)
fig, plots = plt.subplots(nrows=1, ncols=3)
```
```
plots[0].scatter(x, y)
plots[1].plot(x, y)
plots[2].plot(x, y, 'o-')
```
```
plt.show()
```
### 21. Py at Work

21.1 Install geopandas and run Example 21-1. Try modifying things like colors and

marker sizes.

### 22. PySci

22.1 Install Pandas. Get the CSV file in Example 16-1. Run the program in

Example 16-2. Experiment with some of the Pandas commands.

```
Answers to Exercises | 573
```


**APPENDIX E**

**Cheat Sheets**

I find myself looking up certain things a little too often. Here are some tables that I

hope you’ll find useful.

### Operator Precedence

This table is a remix of the official documentation on precedence in Python 3, with

the highest precedence operators at the top.

```
Operator Description and examples
[ v , ...], { v1 , ...}, { k1 : v1 , ...}, (...) List/set/dict/generator creation or comprehension, parenthesized
expression
seq [ n ], seq [ n : m ], func ( args ...), obj. attr Index, slice, function call, attribute reference
** Exponentiation
+ n , – n , ~ n Positive, negative, bitwise not
*, /, //, % Multiplication, float division, int division, remainder
+, - Addition, subtraction
<<, >> Bitwise left, right shifts
& Bitwise and
| Bitwise or
in, not in, is, is not, <, <=, >, >=, !=, == Membership and equality tests
not x Boolean (logical) not
and Boolean and
or Boolean or
if ... else Conditional expression
lambda ... lambda expression
```
##### 575


### String Methods

Python offers both string methods (can be used with any str object) and a string

module with some useful definitions. Let’s use these test variables:

```
>>> s = "OH, my paws and whiskers!"
>>> t = "I'm late!"
```
In the following examples, the Python shell prints the result of the method call, but

the original variables s and t are not changed.

#### Change Case

```
>>> s.capitalize()
'Oh, my paws and whiskers!'
>>> s.lower()
'oh, my paws and whiskers!'
>>> s.swapcase()
'oh, MY PAWS AND WHISKERS!'
>>> s.title()
'Oh, My Paws And Whiskers!'
>>> s.upper()
'OH, MY PAWS AND WHISKERS!'
```
#### Search

```
>>> s.count('w')
2
>>> s.find('w')
9
>>> s.index('w')
9
>>> s.rfind('w')
16
>>> s.rindex('w')
16
>>> s.startswith('OH')
True
```
#### Modify

```
>>> ''.join(s)
'OH, my paws and whiskers!'
>>> ' '.join(s)
'O H , m y p a w s a n d w h i s k e r s !'
>>> ' '.join((s, t))
"OH, my paws and whiskers! I'm late!"
>>> s.lstrip('HO')
', my paws and whiskers!'
>>> s.replace('H', 'MG')
'OMG, my paws and whiskers!'
```
**576 | Appendix E: Cheat Sheets**


```
>>> s.rsplit()
['OH,', 'my', 'paws', 'and', 'whiskers!']
>>> s.rsplit(' ', 1)
['OH, my paws and', 'whiskers!']
>>> s.split(' ', 1)
['OH,', 'my paws and whiskers!']
>>> s.split(' ')
['OH,', 'my', 'paws', 'and', 'whiskers!']
>>> s.splitlines()
['OH, my paws and whiskers!']
>>> s.strip()
'OH, my paws and whiskers!'
>>> s.strip('s!')
'OH, my paws and whisker'
```
#### Format

```
>>> s.center(30)
' OH, my paws and whiskers! '
>>> s.expandtabs()
'OH, my paws and whiskers!'
>>> s.ljust(30)
'OH, my paws and whiskers! '
>>> s.rjust(30)
' OH, my paws and whiskers!'
```
#### String Type

```
>>> s.isalnum()
False
>>> s.isalpha()
False
>>> s.isprintable()
True
>>> s.istitle()
False
>>> s.isupper()
False
>>> s.isdecimal()
False
>>> s.isnumeric()
False
```
```
Cheat Sheets | 577
```

```
1 He’s moved about a foot to the right since Figure 3-1.
```
### String Module Attributes

These are class attributes that are used as constant definitions.

```
Attribute Example
ascii_letters 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'
ascii_lowercase 'abcdefghijklmnopqrstuvwxyz'
ascii_uppercase 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'
digits '0123456789'
hexdigits '0123456789abcdefABCDEF'
octdigits '01234567'
punctuation '!"#$%&\'()*+,-./:;<=>?@[\\]^_\{|}~'`
printable digits + ascii_letters + punctuation + whitespace
whitespace ' \t\n\r\x0b\x0c'
```
### Coda

Chester wants to express his appreciation for your diligence. If you need him, he’s

taking a nap...

Figure E-1. Chester^1

**578 | Appendix E: Cheat Sheets**


...but Lucy is available to answer any questions.

Figure E-2. Lucy

```
Cheat Sheets | 579
```
